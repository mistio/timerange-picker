<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../paper-date-picker/paper-date-picker.html">
<link rel="import" href="../paper-time-picker/paper-time-picker.html">
<link rel="import" href="../paper-button/paper-button.html">
<link rel="import" href="../paper-input/paper-input.html">
<link rel="import" href="../paper-card/paper-card.html">
<link rel="import" href="../paper-dialog/paper-dialog.html">
<link rel="import" href="../paper-dropdown-menu/paper-dropdown-menu.html">
<link rel="import" href="../paper-listbox/paper-listbox.html">
<link rel="import" href="../paper-icon-button/paper-icon-button.html">
<link rel="import" href="../paper-item/paper-item.html">
<link rel="import" href="../iron-icons/iron-icons.html">
<link rel="import" href="../iron-icons/editor-icons.html">


<!--
@demo demo/index.html
@hero hero.svg
-->

<dom-module id="timerange-picker">
    <template>
    <style>
      :host {
        display: flex;
        box-sizing: border-box;
      }

      .author img {
        display: block;
        float: left;
        margin-right: 5px;
        max-height: 100px;
        max-width: 100px;
      }
      #timerange{
        display: inline-block;
        width: 300px;
        float: left;
        border-right: 1px;
            border-right-width: 1px;
            padding: 0 20 0 20px;
            padding-top: 0px;
            padding-right: 20px;
            padding-bottom: 0px;
            padding-left: 20px;
      }
      #quickrange{
        padding: 0 20px 0 30px;
            padding-top: 0px;
            padding-right: 20px;
            padding-bottom: 0px;
            padding-left: 30px;
        min-height: 258px;
        float: left;
      }
      #listbox{
        padding: 0 20px 0 30px;
            padding-top: 0px;
            padding-right: 20px;
            padding-bottom: 0px;
            padding-left: 30px;
        min-height: 258px;
        float: left;
      }
      .from{
        display: inline-block;
      }
      .to{
        display: inline-block;
      }
      .buttons{
        right:20%;
        float: left;
        margin-top: 30px;
      }
      .pick-buttons{
        float: left;
        margin-top: 30px;
      }
      paper-button {
        text-transform: none;
      }
    </style>
    <paper-button  on-tap="minusDuration"><iron-icon icon="icons:chevron-left"></iron-icon></paper-button>
    <paper-button toggles active="{{mainDialogOpen}}">{{durationText}}</paper-button>
    <paper-button id="plusButton" disabled="true" on-tap="plusDuration"><iron-icon icon="icons:chevron-right"></iron-icon></paper-button>
    <paper-dialog opened="{{mainDialogOpen}}" id="dialog" modal class="paper-time-picker-dialog">
      <div id="timerange">
        <h2>Time Range</h2>
          <h4>From:</h4>
          <paper-input id="from" class="from" value="{{innerFrom}}" style="width:70%;" on-tap="clearSelectedButton"></paper-input>
          <paper-button class="from" toggles active="{{fromDialogOpen}}"><iron-icon icon="editor:insert-invitation"></iron-icon></paper-button>
          <h4>To:</h4>
          <paper-input id="to" class="to" value="{{innerTo}}" style="width:70%;" on-tap="clearSelectedButton"></paper-input>
          <paper-button class="to" toggles active="{{toDialogOpen}}"><iron-icon icon="editor:insert-invitation"></iron-icon></paper-button>
      </div>
      <div id="quickrange">
        <h2 style="left:30px;">Quick Ranges</h2>

          <div id="listbox" role="listbox">
              <template is="dom-repeat" items="[[lastxDate]]" as="item">
                  <paper-item id="range" class$="range-button" from$="[[item.from]]" to$="[[item.to]]" type$="[[item.type]]" on-tap="computeDuration">[[item.text]]</paper-item>
              </template>
    <div class="buttons">
        <paper-button dialog-confirm on-tap="addNewDate">Apply</paper-button>
        <paper-button dialog-dismiss>Cancel</paper-button>
    </div>
    </div>
    </paper-dialog>
    <paper-dialog id="datetime" opened="{{fromDialogOpen}}">
        <h2>Select from datetime</h2>
        <div>
            <paper-date-picker id="pickDateFrom" class="date-button"></paper-date-picker>
            <paper-time-picker id="pickTimeFrom" class="time-button"></paper-time-picker>
        </div>
        <div class="pick-buttons">
            <paper-button dialog-confirm on-tap="applyFrom">Apply</paper-button>
            <paper-button dialog-dismiss>Cancel</paper-button>
        </div>
    </paper-dialog>
    <paper-dialog id="datetime" opened="{{toDialogOpen}}">
        <h2>Select to datetime</h2>
        <div>
            <paper-date-picker id="pickDateTo" class="date-button"></paper-date-picker>
            <paper-time-picker id="pickTimeTo" class="time-button"></paper-time-picker>
        </div>
        <div class="pick-buttons">
            <paper-button dialog-confirm on-tap="applyTo">Apply</paper-button>
            <paper-button dialog-dismiss>Cancel</paper-button>
        </div>
    </paper-dialog>
    </template>

    <script>
        Polymer({
            is: 'timerange-picker',

            properties: {
                mainDialogOpen: Boolean,
                fromDialogOpen: Boolean,
                toDialogOpen: Boolean,
                onApply: Boolean,
                lastxDate: Array,
                diff: {
                    type: Number,
                    value: 600000
                },
                endOfDiff: {
                    type: Date
                },
                innerFrom: {
                    type: String,
                    value: '-10min'
                },
                innerTo: {
                    type: String,
                    value: 'now'
                },
                from: {
                    type: String,
                    notify: true
                },
                to: {
                    type: String,
                    notify: true
                },
                step: {
                    type: String,
                    notify: true
                },
                durationText: {
                    type: String,
                    value: '-10min - now'
                },
                autoRefresh: {
                    type: Boolean,
                }
            },

            ready: function() {
                this.endOfDiff = new Date();
                this.lastxDate = [{
                    from: 7,
                    to: "now",
                    type: "days",
                    text: "Last 7 days"
                }, {
                    from: 30,
                    to: "now",
                    type: "days",
                    text: "Last 30 days"
                }, {
                    from: 1,
                    to: "now",
                    type: "year",
                    text: "Last year"
                }, {
                    from: 5,
                    to: "now",
                    type: "minutes",
                    text: "Last 5 minutes"
                }, {
                    from: 30,
                    to: "now",
                    type: "minutes",
                    text: "Last 30 minutes"
                }, {
                    from: 60,
                    to: "now",
                    type: "minutes",
                    text: "Last 1 hour"
                }, {
                    from: 3,
                    to: "now",
                    type: "hours",
                    text: "Last 3 hours"
                }, ];
            },

            applyFrom: function() {
                var dateFrom = this.querySelector('#pickDateFrom'),
                    timeFrom = this.querySelector('#pickTimeFrom');
                this.innerFrom = moment(dateFrom.date).format('MM/DD/YYYY');
                this.innerFrom += " " + moment(timeFrom.time.toString(), "hh:mm A").format('HH:mm');
            },

            applyTo: function() {
                var dateTo = this.querySelector('#pickDateTo'),
                    timeTo = this.querySelector('#pickTimeTo');
                this.innerTo = moment(dateTo.date).format('MM/DD/YYYY');
                this.innerTo += " " + moment(timeTo.time.toString(), "hh:mm A").format('HH:mm');
            },

            computeDuration: function(e) {
                var el = e.srcElement;
                var diff = 0;
                var prevEl = this.querySelector('.range-button[selected="true"]');
                if (prevEl)
                    prevEl.setAttribute("selected", false);
                el.setAttribute("selected", true);
                var from = el.attributes.from.value;
                var to = el.attributes.to.value;
                var val = el.attributes.type.value;
                var newDate = new Date();
                switch (val) {
                    case "days":
                        //alternatively for all
                        //moment(new Date(pastDays)).format('MM/DD/YYYY HH:mm');
                        //var pastDays = newDate.setDate(newDate.getDate() - from);
                        this.innerFrom = -from + "d";
                        this.diff = from * 86400000;
                        break;
                    case "hours":
                        this.innerFrom = -from + "h";
                        this.diff = from * 3600000;
                        break;
                    case "year":
                        this.innerFrom = -from + "y";
                        this.diff = from * 31556952000;
                        break;
                    case "minutes":
                        this.innerFrom = -from + "min";
                        this.diff = from * 60000;
                        break;
                }
                this.innerTo = "now";
                this.querySelector('#plusButton').setAttribute("disabled", "true");
            },
            minusDuration: function() {
                var diff;
                var from = this.from;
                var to = this.to;
                if (this.innerTo == "now" || this.to == "now") {
                    diff = this.diff;
                    to = Math.floor(new Date().getTime() / 1000);
                    from = to - this.diff / 1000;
                } else {
                    diff = this.to * 1000 - this.from * 1000;
                    this.diff = diff;
                }
                this.querySelector('#plusButton').removeAttribute("disabled");
                var start = new Date((from * 1000) - diff);
                var end = new Date((to * 1000) - diff);
                this.durationText = moment(start).format('MM/DD/YYYY HH:mm') + " - " + moment(end).format('MM/DD/YYYY HH:mm');
                this.innerTo = moment(end).format('MM/DD/YYYY HH:mm');
                this.innerFrom = moment(start).format('MM/DD/YYYY HH:mm');
                this.to = Math.floor(end.getTime() / 1000);
                this.from = Math.floor(start.getTime() / 1000);
            },
            plusDuration: function() {
                var diff = this.to * 1000 - this.from * 1000;
                var start = new Date((this.from * 1000 + diff));
                var end = new Date((this.to * 1000 + diff));
                this.durationText = moment(start).format('MM/DD/YYYY HH:mm') + " - " + moment(end).format('MM/DD/YYYY HH:mm');
                if (new Date((this.from * 1000 + diff * 3)) >= new Date()) {
                    this.querySelector('#plusButton').setAttribute("disabled", "true");
                    this.to = "now"
                } else {
                    this.to = Math.floor(end.getTime() / 1000);
                }
                this.innerTo = moment(end).format('MM/DD/YYYY HH:mm');
                this.innerFrom = moment(start).format('MM/DD/YYYY HH:mm');
                this.from = Math.floor(start.getTime() / 1000);
            },
            computeTimespan: function() {
                var numberof = this.from;
                if (typeof this.innerFrom === "string") {
                    console.log("string");
                    numberof = parseInt(this.innerFrom.match(/\d+/g));
                    if (this.innerFrom.search("sec") >= 0) {
                        numberof *= 1;
                        this.step = "1sec";
                    } else if (this.innerFrom.search("min") >= 0) {
                        numberof *= 60;
                    } else if (this.innerFrom.search("month") >= 0) {
                        numberof *= 2629746;
                    } else if (this.innerFrom.search("h") >= 0) {
                        numberof *= 3600;
                    } else if (this.innerFrom.search("d") >= 0) {
                        numberof *= 86400;
                    } else if (this.innerFrom.search("y") >= 0) {
                        numberof *= 31556952;
                    }
                }
                var to = this.innerTo;
                if (this.innerTo == 'now') {
                    to = Math.floor(new Date().getTime() / 1000);
                }
                //less than an  hour
                if (numberof <= 3600) {
                    this.step = "10sec";
                }
                //less than a day
                else if (numberof < 86400) {
                    this.step = "1min";
                }
                //less than a month
                else if (numberof <= 2629746) {
                    this.step = "30min";
                }
                //less than 6 months
                else if (numberof <= 2629746 * 6) {
                    this.step = "1h";
                }
                //less than year
                else if (numberof <= 31556952) {
                    this.step = "5d";
                }
                //more than year
                else {
                    this.step = "1month";
                }
                return numberof;
            },
            clearSelectedButton: function() {
                var prevEl = this.querySelector('.range-button[selected="true"]');
                if (prevEl)
                    prevEl.setAttribute("selected", false);
            },
            addNewDate: function() {
                var start = this.$.from.value;
                var end = this.$.to.value;
                var date = this.$.pickDateFrom.value;
                var time = this.$.pickTimeFrom.value;
                var date2 = this.$.pickDateTo.value;
                var time2 = this.$.pickTimeTo.value;
                var selPickD = this.querySelector('.date-button[selected="true"]');
                var selPickT = this.querySelector('.time-button[selected="true"]');
                var selEl = this.querySelector('.range-button[selected="true"]');
                if (selEl) {
                    this.durationText = selEl.innerText;
                } else if (selPickD) {
                    this.durationText = selPickD.innerText;
                } else if (selPickT) {
                    this.durationText = selPickT.innerText;
                } else {
                    this.datetime = start + "-" + end;
                    this.durationText = this.datetime;
                }
                var span=this.computeTimespan();
                if (this.innerTo != "now") {
                    var df = new Date(this.innerFrom);
                    var dt = new Date(this.innerTo);
                    // we use this because we update the graph when ONLY "from" changes value not "To". if we trigger the change with "From" AND "To" there would be double requests etc.
                    //so in case we change only "To" nothing would have happened
                    var fromTrigger = 0;
                    if (this.from == new Date(this.innerFrom).getTime() / 1000) {
                        fromTrigger = 1;
                    }
                    this.to = dt.getTime() / 1000;
                    this.from = (df.getTime() / 1000) + fromTrigger;
                } else {
                    this.to = Math.floor(new Date().getTime()/1000);
                    this.from = this.to-span;
                }
            },
            attached: function() {
                // `attached` fires once the element and its parents have been inserted
                // into a document.
                //
                // This is a good place to perform any work related to your element's
                // visual state or active behavior (measuring sizes, beginning animations,
                // loading resources, etc).
            },

            detached: function() {
                // The analog to `attached`, `detached` fires when the element has been
                // removed from a document.
                //
                // Use this to clean up anything you did in `attached`.
            },
        });
    </script>
</dom-module>
